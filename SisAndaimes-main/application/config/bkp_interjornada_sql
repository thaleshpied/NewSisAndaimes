SELECT

CODCOLIGADA,
CODSECAO,
SECAO, 
CHAPA, 
NOME, 
COUNT (DIA) AS QTD_DIAS_HORAEXTRA, 
SUM (HORAS_EXTRAS_NO_DIA) AS QTD_HORAEXTRA,
0 AS QTD_DIAS_ITERJORNADA

FROM 

(

SELECT
PFUNC.CODCOLIGADA,
PFUNC.CODSECAO,
PSECAO.DESCRICAO AS SECAO,
PFUNC.CHAPA, PFUNC.NOME, HORAS.DATA AS DIA,
(SUM(HORAS.HTRAB) / 60.00) AS HORAS_TRABALHADAS_NO_DIA,
(SUM(HORAS.EXTRAEXECUTADO) / 60.00) AS HORAS_EXTRAS_NO_DIA,

-- CRIANDO VALIDAÇÃO PARA INDICAR SE A QUANTIDADE DE HORA EXTRA ESTÁ DENTRO DO PERMITIDO OU NÃO
CASE
	WHEN HORAS.EXTRAEXECUTADO > 120 
	THEN 'Acima do Permitido'
	ELSE 'Correto'
END AS VALIDACAO_DE_HORAS,

-- CRIANDO COLUNA PARA INDICAR SE É UM DIA ATÍPICO OU NÃO POIS A HORA EXTRA ESTÁ IGUAL A HORA TRABALHADA
CASE
	WHEN HORAS.EXTRAEXECUTADO = HORAS.HTRAB
	THEN 'Dia Atípico'
	ELSE 'Dia Comum'
END AS OBSERVACAO_IMPORTANTE


FROM PFUNC

	INNER JOIN 
	AAFHTFUN AS HORAS 
	ON	PFUNC.CODCOLIGADA = HORAS.CODCOLIGADA
	AND PFUNC.CHAPA = HORAS.CHAPA

	INNER JOIN 
	PSECAO 
	ON	PFUNC.CODCOLIGADA = PSECAO.CODCOLIGADA
	AND PFUNC.CODSECAO = PSECAO.CODIGO
-- PSECAO CAMPOS IMPORTANTES -> DESCRICAO, CODIGO, CODCOLIGADA, 
-- PFUNC CAMPOS IMPORTANTES -> CODSECAO (ESTE CÓDIGO INDICA A SECAO DO FNCIONARI0O 


-- WHERE PARA FILTRAR SOMENTE O QUE GEROU HORA EXTRA 
WHERE	PFUNC.CODCOLIGADA = @CODCOLIGADA 
AND HORAS.EXTRAEXECUTADO > 0
AND HORAS.DATA BETWEEN @DATAINICIO AND @DATAFIM
AND PFUNC.CODSECAO IN (@CODSECAO)

GROUP BY PFUNC.CODCOLIGADA, PFUNC.CODSECAO, PSECAO.DESCRICAO, PFUNC.NOME, HORAS.DATA, HORAS.HTRAB, HORAS.EXTRAEXECUTADO, PFUNC.CHAPA

) AS TAB

WHERE TAB.VALIDACAO_DE_HORAS = 'Acima do Permitido'

GROUP BY CODCOLIGADA, CODSECAO, SECAO, CHAPA, NOME